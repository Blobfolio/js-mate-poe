<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>RS Mate Poe: Sprite Reference</title>

	<link rel="stylesheet" href="assets/tiles.css">
</head>
<body>
	<div id="sprite"></div>
	<div id="playlist"></div>
	<div id="movie"><div class="frame"></div></div>
	<select id="fps">
		<option value="50">50ms</option>
		<option value="75">75ms</option>
		<option value="100">100ms</option>
		<option value="125">125ms</option>
		<option value="150">150ms</option>
		<option value="175">175ms</option>
		<option value="200" selected>200ms</option>
		<option value="225">225ms</option>
		<option value="250">250ms</option>
		<option value="275">275ms</option>
		<option value="300">300ms</option>
		<option value="325">325ms</option>
		<option value="350">350ms</option>
	</select>

	<script>
		// Place each frame in a grid.
		const masks = [21, 100, 133];
		const halves = [31, 32, 33];

		// Make a frame.
		const makeFrame = function(cls) {
			let frame = document.createElement('div');
			frame.classList.add('frame');
			frame.classList.add(cls);
			frame.setAttribute('data-class', cls);

			let id = cls;
			if (0 === cls.indexOf('f')) { id = cls.slice(1); }
			frame.setAttribute('data-frame', id);

			return frame;
		};

		// Add each frame to the table.
		for (let i = 0; i <= 165; ++i) {
			// Add the mask?
			if (-1 !== masks.indexOf(i)) {
				let frame = makeFrame(`fm${i}`);
				sprite.appendChild(frame);
			}

			let frame = makeFrame(`f${i}`);
			sprite.appendChild(frame);
		}

		// Add the halfsies to the end.
		for (let i of halves) {
			let frame = makeFrame(`fh${i}`);
			sprite.appendChild(frame);
		}

		// More DOM elements worth remembering.
		const playlist = document.getElementById('playlist');
		const movie = document.getElementById('movie');
		const movieFrame = movie.querySelector('.frame');
		const fps = document.getElementById('fps');

		// Current frame ID (for movie).
		let nowPlaying = 0;

		// setInterval ID, if any.
		let timerId = 0;
		let movieSpeed = 200;

		// Repopulate the playlist from the `list` variable, and (re)start the
		// movie timer if applicable. (If not, kill the timer and do nothing.)
		const startMovie = function() {
			// Reset the list id and timer.
			if (timerId !== 0) {
				clearInterval(timerId);
				timerId = 0;
			}
			nowPlaying = 0;

			// If the list is empty, we're done.
			if (0 === playlist.children.length) {
				movie.classList.remove('play');
				return;
			}

			// Animate!
			timerId = setInterval(renderMovie, parseInt(fps.value, 10));
		};

		// Switch movie frames (if playing).
		const renderMovie = function() {
			// Do nothing if empty.
			if (0 === playlist.children.length) { return; }

			// Loop the list id if needed.
			if (nowPlaying >= playlist.children.length) { nowPlaying = 0; }

			// Pull the playlist frame and class.
			let frame1 = playlist.children[nowPlaying];
			if (null === frame1) { return; }
			let cls = frame1.getAttribute('data-class');
			if (('string' !== typeof cls) || ! cls) { return; }

			// Pull the movie frame.
			movieFrame.className = `frame ${cls}`;

			// Update classes.
			movie.classList.add('play');
			for (let i = 0; i < playlist.children.length; ++i) {
				playlist.children[i].classList.toggle('is-current', i === nowPlaying);
			}

			// Increment the list id for next time.
			nowPlaying += 1;
		}

		// Clicking a frame in the sprite table queues it up.
		sprite.addEventListener('click', function(e) {
			if (e.target.classList.contains('frame')) {
				let frame = e.target.cloneNode(true);
				playlist.appendChild(frame);
				startMovie();
			}
		}, { passive: true });

		// Clicking a frame in the playlist table removes it.
		playlist.addEventListener('click', function(e) {
			if (e.target.classList.contains('frame')) {
				playlist.removeChild(e.target);
				startMovie();
			}
		}, { passive: true });

		// Changing the speed resets the playlist.
		fps.addEventListener('change', function(e) { startMovie(); })
	</script>
</body>
</html>
